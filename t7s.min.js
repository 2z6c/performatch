$(document).ready(function(){"use strict";var a="1.3.0",b=[{name:"ボーカリスト",tag:"Vo"},{name:"バラドル",tag:"Va"},{name:"モデル",tag:"Mo"},{name:"プレイヤー",tag:"Pl"},{name:"ダンサー",tag:"Da"},{name:"ノータイプ",tag:"NT"}],c="Vo Va Mo Pl Da NT ",d={},e=$("body"),f=$("#config"),g=$(".unit td"),h=$(".unit"),i=$("#result-table tbody"),j=$("#known-unit-wrapper"),k=$("#you"),l=$("#rival"),m=$("#message"),n=$("#unit-data-list"),o=function(a,b){return a-b},p=function(a){return 0>=a?1:a*p(a-1)},q={n:0};q.YN=function(a,b){var c=this;this.text=a,this.value=b||!1;var d="TN"+q.n++,e=$("<input>").prop({type:"checkbox",checked:this.value,id:d}).on({change:function(){c.value=e.prop("checked")}});this.$input=$("<p>").addClass("config-input").append(e);var f=$("<label>").text(a).prop("for",d);this.$label=$("<p>").addClass("config-label").append(f)},q.YN.prototype.set=function(a){this.value=!!a,this.$input.children("input").prop({checked:a})},q.Radio=function(a,b,c){var d=this;this.value=c||0;var e="radio"+q.n++;this.text=a,this.$label=$("<p>").addClass("config-label").text(a),this.$input=$("<p>").addClass("config-input");for(var f,g=0;f=b[g];g++){var h=$("<label>").text(f).prop("for",e+"-"+g),i=$("<input>").prop({type:"radio",name:e,id:e+"-"+g,value:g,checked:g===this.value}).on({change:function(a){return function(){d.value=a}}(g)});this.$input.append(i,h,"<br>")}},q.Radio.prototype.set=function(a){this.value=parseInt(a),this.$input.children("input").prop({checked:!1}).eq(a).prop({checked:!0})},q.Quantity=function(a,b,c,d){var e=this;this.text=a,this.$label=$("<p>").addClass("config-label").text(a);var f=$("<input>").prop({type:"number",min:b,max:c,value:d||b}).addClass("config-number").on({change:function(){e.value=f.val()}});this.$input=$("<p>").addClass("config-input").append(f),this.value=d||b},q.Quantity.prototype.set=function(a){this.value=a,this.$input.children("input").prop({value:a})};var r={lowestBonus:new q.YN("最下位ボーナスを適用",!1),countDrawAs:new q.Radio("引き分けのカウント法",["勝利としてカウント","敗北としてカウント","勝敗をランダムに決定"],1),countPerMatch:new q.Radio("勝数カウント",["マッチ勝数(3回勝負ごと)","総合勝数(1回勝負ごと)"]),ignoreUserType:new q.Radio("タイプ一致ボーナス",["勝敗判定に使用する","無視する"]),resultDisplay:new q.Quantity("結果の表示数",1,1680,8),resetWhenRegroup:new q.YN("編成変更時に確定枠をリセットする",!0),omitDuplicatedResults:new q.YN("ステージを並び替えて重複する結果を除外",!1),showProgress:new q.YN("計算中プログレスバーを表示する",!0),messageFadeTime:new q.Quantity("メッセージの表示時間(秒)",0,1/0,1)};for(var s in r){var t=$("<div>").addClass("config-content").appendTo(f);r[s].$label.appendTo(t),r[s].$input.appendTo(t)}for(var u=$(".known-unit"),v=function(a){var b=u.clone().removeClass("template").appendTo(j),d=b.find(".unit-caption").text(["1st","2nd","3rd"][a]+" Stage"),e=$("<span>").addClass("expectation").appendTo(d).on({click:function(a){var b=$(this);b.toggleClass("win lose").text("WIN"===b.text()?"LOSE":"WIN")}});b.find("td:not(:last-child)").addClass("idol").on({click:function(a){var c=$(this);return F(a,function(a){c.removeClass("error"),H(c,a);var d=c.data("manager");try{d.input()}catch(f){R(f),d.resetFix()}0===$("td:empty",b).length?x(b,e):e.empty().removeClass("win lose")},!0),!1}}),b.find("td:last-child").append($('<a class="button">').text("Reset").on({click:function(){var a=$(this);a.parent().siblings("td").empty().removeClass(c+"error"),e.empty().removeClass("win lose")}}))},w=0;3>w;w++)v(w);var x=function(a,b){var c=a.find(".idol").not(":empty");if(6===c.length){for(var d=[[],[]],e=0;3>e;e++)d[0].push(c.eq(e).data("type")),d[1].push(c.eq(e+3).data("type"));var f=C(c.first().data("manager").type,d[0],c.last().data("manager").type,d[1]);b.text(f?"WIN":"LOSE").removeClass("win lose").addClass(f?"win":"lose")}};u.remove();var y=function(a){return 0>a||a>=5||!isFinite(a)?NaN:(a+1)%5},z=function(a,b,c,d){return y(b)===d?3:b===y(d)?-3:0===r.ignoreUserType.value&&a===b&&c!==d?1:0===r.ignoreUserType.value&&a!==b&&c===d?-1:r.lowestBonus.value?1:0},A=0,B=0,C=function(a,b,c,d){for(var e=A-B,f=A+B;3>f;f++){for(var g=0,h=0;3>h;h++)g+=z(a,b[3*f+h],c,d[3*f+h]);if(g>0)e++;else if(1===r.countPerMatch.value){if(0===g)switch(r.countDrawAs.value){case 0:e++;break;case 2:e+=Math.round(Math.random())}}else 0>g&&e--;if(0===r.countPerMatch.value&&Math.abs(e)>=2)return e>0}if(1===r.countPerMatch.value)return Math.max(e,0);if(0!==e)return e>0;switch(r.countDrawAs.value){case 0:return!0;case 1:return!1;case 2:return Math.random()>.5}},D=function(a,b){this.type=0,this.unit=[0,0,0,0,0,0,0,0,0],this.fixed=[],this.rest=this.unit,this.$=a,this.$table=a.children(".unit").data("manager",this),this.$cell=a.find(".unit td"),this.$pattern=a.find(".pattern"),this.$known=b.children("td:not(:last-child)").data("manager",this)};D.prototype={getPattern:function(){for(var a=[0,0,0,0,0],b=0;9>b;b++)a[this.unit[b]]++;for(var c=362880,d=0;5>d;d++)c/=p(a[d]);return c},resetFix:function(){this.fixed=[],this.rest=[].concat(this.unit)},sort:function(){this.unit.sort(o),this.rest.sort(o)},input:function(){var a=this;this.type=this.$table.data("type"),this.$cell.each(function(b,c){var d=$(c).data("type");a.unit[b]=d}),this.resetFix();for(var b=0;9>b;b++){var c=this.$known.eq(b);if(""===c.text())break;var d=c.removeClass("error").data("type");this.fixed.push(d);var e=this.rest.indexOf(d);if(0>e)throw c.addClass("error"),"確定欄のユニットが編成不可能な組合せです";this.rest.splice(e,1)}this.sort()},output:function(){var a=b[this.type].tag;this.$table.data("type",this.type).removeClass("Vo Va Mo Pl Da").addClass(a);for(var c=0;9>c;c++)H(this.$cell.eq(c),this.unit[c])},save:function(a){d.hasOwnProperty(a)||$("<option>").text(a).prop({val:a}).appendTo(n),d[a]={type:this.type,unit:this.unit};var b=JSON.stringify(d);window.localStorage.setItem("unit",b),window.localStorage.setItem("default_unit",a),R("["+a+"]を保存しました")},load:function(a){var b=d[a];if(!b)throw"["+a+"]にはユニットデータがありません";this.type=b.type,this.unit=[].concat(b.unit||[0,0,0,0,0,0,0,0,0]),this.output(),window.localStorage.setItem("default_unit",a)}};var E=[new D(k,$(".you.used-unit")),new D(l,$(".rival.used-unit"))],F=function(a,c,d){var f=d?6:5;$(".type-select").remove(),g.removeClass("selecting");for(var h=$("<ul>").addClass("type-select").appendTo(e).css({top:a.pageY,left:a.pageX}),i=0;f>i;i++){var j=$("<a>").text(b[i].tag).addClass(b[i].tag).attr({title:b[i].name});j.on({click:function(a){return function(b){return c(a),G(b),!1}}(i)}).appendTo(h).wrap('<li class="type-option">')}a.stopPropagation()},G=function(a){var b=$(".type-select").eq(0);b.addClass("dispose").delay(150).queue(function(a){b.hide().remove()}),g.removeClass("selecting"),a.stopPropagation()},H=function(a,c){var d=b[c].tag;a.removeClass("Vo Va Mo Pl Da NT selecting").addClass(d).text(d).data("type",c)};h.on({click:function(a){var c=$(this);return F(a,function(a){var d=b[a].tag;c.removeClass("Vo Va Mo Pl Da").addClass(d).data("type",a),c.data("manager").input()},!1),!1}}).addClass("Vo").data("type",0),g.on({click:function(a){var b=$(this);return r.resetWhenRegroup.value&&Q(),F(a,function(a){H(b,a);try{b.closest("table").data("manager").input()}catch(c){c instanceof Error?console.error(c):R(c)}},!0),b.addClass("selecting"),!1}}).text("Vo").addClass("Vo").data("type",0),e.on({click:G}),!function(){var a=$("#progress"),c=$("#bar"),d=0,e=0,f=[];$("#VS").on({click:function(){new Promise(function(b){i.empty(),E[0].input(),E[1].input(),a.show(),A=$(".win").length,B=$(".lose").length,setTimeout(b,0)}).then(g).then(function(){return j(E[0],E[1])})["catch"](function(a){a instanceof Error?console.error(a):R(a),window.ga&&ga("send","exception",{exDescription:a.message||a,exFatal:a instanceof Error})}).then(function(){a.fadeOut(),c.fadeOut()})}});var g=function(){return new Promise(function(a,b){for(var c=0;2>c;c++){var d=E[c].fixed.length;if(d%3>0)return E[c].$known.eq(d).addClass("error"),b("確定枠はステージ(3人)単位で指定してください。")}a()})},h=0,j=function(a,b){window.performance&&(h=performance.now());var c=[];c=J(b.fixed,b.rest,b.rest.length);var d=[],e=b.fixed.length-a.fixed.length;if(e>0)for(var f,g=J(a.fixed,a.rest,e),i=0;f=g[i];i++){for(var j=a.unit.slice(0),k=0,l=f.length;l>k;k++)j.splice(j.indexOf(f[k]),1);d=d.concat(K(j,f))}else d=K(a.rest,a.fixed);return m(d,c)},k=function(){d++;var a=Math.round(100*d/e);c.width(a+"%")},l=function(a,b){return new Promise(function(c){for(var d,e={unit:a,win:0},g=0;d=b[g];g++){var h=C(E[0],a,E[1],d);1===r.countPerMatch.value?e.win+=h:h&&e.win++}f.push(e),r.showProgress.value&&k(),setTimeout(c,0)})},m=function(a,b){d=0,e=a.length,r.showProgress.value&&c.width(0).show(),f=[];for(var g=Promise.resolve(),i=0,j=a.length;j>i;i++)g=g.then(l.bind(null,a[i],b));return g.then(function(){f.sort(function(a,b){return b.win-a.win});for(var a=0,c=0,d=0,e=parseInt(r.resultDisplay.value)||10,g=[],i=Math.max(E[0].fixed.length,E[1].fixed.length);e>c&&f[a];){var j=f[a];if(a>0&&j.win===f[a-1].win&&r.omitDuplicatedResults.value){if(p(j.unit,g,i)){a++;continue}}else d=c+1;g.push(j.unit.toString()),n(d,j.unit,(j.win/b.length).toFixed(3)),a++,c++}if(window.ga){ga("send","event","fixed","you",E[0].fixed.length),ga("send","event","fixed","rival",E[1].fixed.length);for(var k in r)r.hasOwnProperty(k)&&ga("send","event","config",r[k].text,r[k].value);if(window.performance){var l=E[0].fixed.length+":"+E[1].fixed.length;ga("send","timing","Calculation",l,performance.now()-h)}}})},n=function(a,c,d){for(var e=$("<tr>").appendTo(i).append($("<td>").text(a).addClass("rank")),f=0;3>f;f++)for(var g=$("<td>").addClass("unit3-wrapper").appendTo(e),h=0;3>h;h++){var j=b[c[3*f+h]].tag;$("<div>").addClass("idol "+j).text(j).data("type",c[3*f+h]).appendTo(g)}$("<td>").text(d).appendTo(e).addClass("rate");var k=[o(1,e),o(2,e)];$("<td>").addClass("util").append(k).appendTo(e)},o=function(a,b){return $("<a>").text(a).on({click:I.bind(null,a,b)}).addClass("copy button").attr("title",["1st","2nd","3rd"][a-1]+"ステージの並びを確定欄に反映")},p=function(a,b,c){if(c>=6)return!1;if(3>=c&&~b.indexOf([a[0],a[1],a[2],a[6],a[7],a[8],a[3],a[4],a[5]].toString()))return!0;if(0===c){if(~b.indexOf([a[6],a[7],a[8],a[0],a[1],a[2],a[3],a[4],a[5]].toString()))return!0;if(~b.indexOf([a[6],a[7],a[8],a[3],a[4],a[5],a[0],a[1],a[2]].toString()))return!0;if(~b.indexOf([a[3],a[4],a[5],a[0],a[1],a[2],a[6],a[7],a[8]].toString()))return!0;if(~b.indexOf([a[3],a[4],a[5],a[6],a[7],a[8],a[0],a[1],a[2]].toString()))return!0}return!1}}();var I=function(a,b){for(var c=b.find(".idol"),d=3*(a-1);3*a>d;d++){var e=c.eq(d).data("type");H(E[0].$known.eq(d),e)}var f=$(".known-unit").eq(a-1);x(f,f.find(".expectation")),E[0].input()};$("#reset-all").on({click:function(){i.empty(),Q()}});for(var J=function(a,b,c){var d=[];return function e(a,b,c){if(c>0){for(var f=0,g=b.length;g>f;f++)if(!(f>0&&b[f]===b[f-1])){var h=[].concat(b),i=h.splice(f,1);e(a.concat(i),h,c-1)}}else d.push(a)}(a,b,c),d},K=function(a,b){if(!a.length)return[b];a.sort(o),b=b||[];var c=a.length;if(3===c)return[b.concat(a)];for(var d=[],e=0;c-2>e;e++)if(!(e>0&&a[e]===a[e-1]))for(var f=e+1;c-1>f;f++)if(!(f>e+1&&a[f]===a[f-1]))for(var g=f+1;c>g;g++)if(!(g>f+1&&a[g]===a[g-1])){var h=[a[e],a[f],a[g]];if(d[0]!==h){var i=a.slice(0);i.splice(g,1),i.splice(f,1),i.splice(e,1);for(var j=K(i,b.slice(3)),k=0,l=j.length;l>k;k++)d.push(b.concat(h,j[k]))}}return d},L=[{text:"単色染め",generate:function(a){var b=a.type;a.unit=[b,b,b,b,b,b,b,b,b]}},{text:"両翼楔型",generate:function(a){var b=a.type,c=(b+2)%5,d=(b+3)%5;a.unit=[b,b,b,c,c,c,d,d,d]}},{text:"楔型弱点カバー",generate:function(a){var b=a.type,c=(b+3)%5,d=(c+3)%5;a.unit=[b,b,b,c,c,c,d,d,d]}},{text:"63弱点カバー",generate:function(a){var b=a.type,c=(b+3)%5;a.unit=[b,b,b,b,b,b,c,c,c]}},{text:"ランダム",generate:function(a){a.type=Math.floor(5*Math.random());for(var b=0;9>b;b++)a.unit[b]=Math.floor(5*Math.random())}}],M=$("<ul>").appendTo("#rival-template"),N=function(a){var b=L[a];$("<a>").addClass("button").on({click:function(){Q(),b.generate(E[1]),E[1].output()}}).text(b.text).appendTo(M).wrap("<li>")},O=0;O<L.length;O++)N(O);var P,Q=function(){for(var a=0;2>a;a++)E[a].$known.removeClass(c+"error").empty(),E[a].fixed=[],E[a].rest=E[a].unit;$(".expectation").empty().removeClass("win lose")},R=function(a){var b=1e3*r.messageFadeTime.value;m.text(a).show().delay(b).fadeOut({complete:function(){m.text("")}}),console.info(a)};!function(){var a=$("#overlay"),b=void 0,c=function(){return 0},e=function(d,e){return a.has(d)?(b=d,c=e,a.fadeIn({easing:"easeOutExpo"}),void d.animate({top:"10%"},{easing:"easeOutBack"})):!1};P=function(){b.animate({top:"200%"},{easing:"easeInBack"}),a.fadeOut({easing:"easeInExpo"}),c&&c()},a.on({click:P}).children().on({click:function(a){a.stopPropagation()}}),$(".close-button").text("×").on({click:P}),$("#config-button").on({click:function(){e(f,function(){var a={};for(var b in r)r.hasOwnProperty(b)&&(a[b]=r[b].value);var c=JSON.stringify(a);window.localStorage.setItem("config",c)})}}),!function(){var a=$("#input-save-name").on({click:function(){return a.select(),!1},focus:function(){a.select()}}),b=$("#save-dialog");b.find(".button").on({click:function(){var b=a.val();E[0].save(b),n.val(b),P()}}),$("#save-unit").addClass("save").on({click:function(){e(b,function(){return 0})}});var c=$("#simple-dialog"),f=$("#dialog-text"),g=$("#dialog-ok");c.find(".button").on({click:P}),n.on({change:function(){a.val(n.val()),E[0].load(n.val())}});var h=function(a,b){b.remove(),delete d[a],window.localStorage.setItem("unit",JSON.stringify(d)),window.localStorage.setItem("default_unit",n.children().first().val())};$("#delete-unit").on({click:function(){var a=n.find("option:selected"),b=a.text();f.text("本当に["+b+"]を削除してもよろしいですか？"),g.off(".delete").on("click.delete",function(){R("["+b+"]を削除しました。"),h(b,a)}),e(c,function(){return 0})}})}()}(),Promise.resolve(0).then(function(){$("#unable-js").remove(),$("#unit-area").show(),$("#version").text("ver. "+a);var b=window.localStorage.getItem("unit");if(b){var c=JSON.parse(b);for(var e in c)d[e]=c[e],$("<option>").text(e).prop({val:e}).appendTo(n);var f=window.localStorage.getItem("default_unit");void 0!==f&&d[f]&&E[0].load(f)}})["catch"](function(a){console.debug("初期化処理に失敗しました",a),window.localStorage.clear()}).then(function(){var a=window.localStorage.getItem("config");if(a){var b=JSON.parse(a);for(var c in b)r.hasOwnProperty(c)&&r[c].set(b[c])}})}),window.Promise||window.ga&&ga("send","exception",{exDescription:"Promise unsupported",exFatal:!0});