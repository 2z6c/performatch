function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}$(document).ready(function(){"use strict";var a="1.4.0",b=[{name:"ボーカリスト",tag:"Vo"},{name:"バラドル",tag:"Va"},{name:"モデル",tag:"Mo"},{name:"プレイヤー",tag:"Pl"},{name:"ダンサー",tag:"Da"},{name:"ノータイプ",tag:"NT"}],c="Vo Va Mo Pl Da NT ",d={},e=$("body"),f=$("#config"),g=$(".unit td"),h=$(".unit"),i=$("#result-table tbody"),j=$("#known-unit-wrapper"),k=$("#you"),l=$("#rival"),m=$("#message"),n=$("#unit-data-list"),o=function(a,b){return a-b},p=function(a){return 0>=a?1:a*p(a-1)},q="click";"ontouchstart"in window&&!function(){var a=!1;q="tap",$(document).on({touchstart:function(){a=!0},touchmove:function(){a=!1}});var b=function(b){return a?(a=!1,$.event.dispatch.call(this,$.Event("tap",{originalEvent:b,target:b.target,pageX:b.changedTouches[0].pageX,pageY:b.changedTouches[0].pageY})),!1):void 0};$.event.special.tap={setup:function(){this.addEventListener("touchend",b,!1)},teardown:function(){this.removeEventListener("touchend",b,!1)}}}();var r={n:0};r.YN=function(a,b){var c=this;this.text=a,this.value=b||!1;var d="TN"+r.n++,e=$("<input>").prop({type:"checkbox",checked:this.value,id:d}).on({change:function(){c.value=e.prop("checked")}});this.$input=$("<p>").addClass("config-input").append(e);var f=$("<label>").text(a).prop("for",d);this.$label=$("<p>").addClass("config-label").append(f)},r.YN.prototype.set=function(a){this.value=!!a,this.$input.children("input").prop({checked:a})},r.Radio=function(a,b,c){var d=this;this.value=c||0;var e="radio"+r.n++;this.text=a,this.$label=$("<p>").addClass("config-label").text(a),this.$input=$("<p>").addClass("config-input");for(var f,g=0;f=b[g];g++){var h=$("<label>").text(f).prop("for",e+"-"+g),i=$("<input>").prop({type:"radio",name:e,id:e+"-"+g,value:g,checked:g===this.value}).on({change:function(a){return function(){d.value=a}}(g)});this.$input.append(i,h,"<br>")}},r.Radio.prototype.set=function(a){this.value=parseInt(a),this.$input.children("input").prop({checked:!1}).eq(a).prop({checked:!0})},r.Quantity=function(a,b,c,d){var e=this;this.text=a,this.$label=$("<p>").addClass("config-label").text(a);var f=$("<input>").prop({type:"number",min:b,max:c,value:d||b}).addClass("config-number").on({change:function(){e.value=f.val()}});this.$input=$("<p>").addClass("config-input").append(f),this.value=d||b},r.Quantity.prototype.set=function(a){this.value=a,this.$input.children("input").prop({value:a})};var s={lowestBonus:new r.YN("最下位ボーナスを適用",!1),countDrawAs:new r.Radio("引き分けのカウント法",["勝利としてカウント","敗北としてカウント","勝敗をランダムに決定"],1),countPerMatch:new r.Radio("勝数カウント",["マッチ勝数(3回勝負ごと)","総合勝数(1回勝負ごと)"]),ignoreUserType:new r.Radio("タイプ一致ボーナス",["勝敗判定に使用する","無視する"]),resultDisplay:new r.Quantity("結果の表示数",1,1680,8),resetWhenRegroup:new r.YN("編成変更時に確定枠をリセットする",!0),omitDuplicatedResults:new r.YN("ステージを並び替えて重複する結果を除外",!1),showProgress:new r.YN("計算中プログレスバーを表示する",!0),messageFadeTime:new r.Quantity("メッセージの表示時間(秒)",0,1/0,1)};for(var t in s){var u=$("<div>").addClass("config-content").appendTo(f);s[t].$label.appendTo(u),s[t].$input.appendTo(u)}for(var v=$(".known-unit"),w=function(a){var b=v.clone().removeClass("template").appendTo(j),d=b.find(".unit-caption").text(["1st","2nd","3rd"][a]+" Stage"),e=$("<span>").addClass("expectation").appendTo(d).on(_defineProperty({},q,function(a){var b=$(this);b.toggleClass("win lose").text("WIN"===b.text()?"LOSE":"WIN")}));b.find("td:not(:last-child)").addClass("idol").on(_defineProperty({},q,function(a){var c=$(this);return G(a,function(a){c.removeClass("error"),I(c,a);var d=c.data("manager");try{d.input()}catch(f){U(f),d.resetFix()}0===$("td:empty",b).length?y(b,e):e.empty().removeClass("win lose")},!0),!1})),b.find("td:last-child").append($('<a class="button">').text("Reset").on(_defineProperty({},q,function(){var a=$(this);a.parent().siblings("td").empty().removeClass(c+"error"),e.empty().removeClass("win lose")})))},x=0;3>x;x++)w(x);var y=function(a,b){var c=a.find(".idol").not(":empty");if(6===c.length){for(var d=[[],[]],e=0;3>e;e++)d[0].push(c.eq(e).data("type")),d[1].push(c.eq(e+3).data("type"));var f=D(c.first().data("manager").type,d[0],c.last().data("manager").type,d[1]);b.text(f?"WIN":"LOSE").removeClass("win lose").addClass(f?"win":"lose")}};v.remove();var z=function(a){return 0>a||a>=5||!isFinite(a)?NaN:(a+1)%5},A=function(a,b,c,d){return z(b)===d?3:b===z(d)?-3:0===s.ignoreUserType.value&&a===b&&c!==d?1:0===s.ignoreUserType.value&&a!==b&&c===d?-1:s.lowestBonus.value?1:0},B=0,C=0,D=function(a,b,c,d){for(var e=B-C,f=B+C;3>f;f++){for(var g=0,h=0;3>h;h++)g+=A(a,b[3*f+h],c,d[3*f+h]);if(g>0)e++;else if(1===s.countPerMatch.value){if(0===g)switch(s.countDrawAs.value){case 0:e++;break;case 2:e+=Math.round(Math.random())}}else 0>g&&e--;if(0===s.countPerMatch.value&&Math.abs(e)>=2)return e>0}if(1===s.countPerMatch.value)return Math.max(e,0);if(0!==e)return e>0;switch(s.countDrawAs.value){case 0:return!0;case 1:return!1;case 2:return Math.random()>.5}},E=function(a,b){this.type=0,this.unit=[0,0,0,0,0,0,0,0,0],this.fixed=[],this.rest=this.unit,this.$=a,this.$table=a.children(".unit").data("manager",this),this.$cell=a.find(".unit td"),this.$pattern=a.find(".pattern"),this.$known=b.children("td:not(:last-child)").data("manager",this)};E.prototype={getPattern:function(){for(var a=[0,0,0,0,0],b=0;9>b;b++)a[this.unit[b]]++;for(var c=362880,d=0;5>d;d++)c/=p(a[d]);return c},resetFix:function(){this.fixed=[],this.rest=[].concat(this.unit)},sort:function(){this.unit.sort(o),this.rest.sort(o)},input:function(){var a=this;this.type=this.$table.data("type"),this.$cell.each(function(b,c){var d=$(c).data("type");a.unit[b]=d}),this.resetFix();for(var b=0;9>b;b++){var c=this.$known.eq(b);if(""===c.text())break;var d=c.removeClass("error").data("type");this.fixed.push(d);var e=this.rest.indexOf(d);if(0>e)throw c.addClass("error"),"確定欄のユニットが編成不可能な組合せです";this.rest.splice(e,1)}this.sort()},output:function(){var a=b[this.type].tag;this.$table.data("type",this.type).removeClass("Vo Va Mo Pl Da").addClass(a);for(var c=0;9>c;c++)I(this.$cell.eq(c),this.unit[c])},save:function(a){d.hasOwnProperty(a)||$("<option>").text(a).prop({val:a}).appendTo(n),d[a]={type:this.type,unit:[].concat(this.unit)};var b=JSON.stringify(d);window.localStorage.setItem("unit",b),window.localStorage.setItem("default_unit",a),U("["+a+"]を保存しました")},load:function(a){var b=d[a];if(!b)throw"["+a+"]にはユニットデータがありません";this.type=b.type,this.unit=[].concat(b.unit||[0,0,0,0,0,0,0,0,0]),this.output(),window.localStorage.setItem("default_unit",a)}};var F=[new E(k,$(".you.used-unit")),new E(l,$(".rival.used-unit"))],G=function(a,c,d){var f=d?6:5;$(".type-select").remove(),g.removeClass("selecting");for(var h=$("<ul>").addClass("type-select").appendTo(e).css({top:a.pageY,left:a.pageX}).delay(200).queue(function(a){h.addClass("stable")}),i=0;f>i;i++){var j=$("<a>").text(b[i].tag).addClass(b[i].tag).attr({title:b[i].name});j.on(_defineProperty({},q,function(a){return function(b){return c(a),H(b),!1}}(i))).appendTo(h).wrap('<li class="type-option">')}a.stopPropagation()},H=function(a){var b=$(".type-select").eq(0);b.addClass("dispose").delay(150).queue(function(a){b.hide().remove()}),g.removeClass("selecting"),a.stopPropagation()},I=function(a,c){var d=b[c].tag;a.removeClass("Vo Va Mo Pl Da NT selecting").addClass(d).text(d).data("type",c)};h.on(_defineProperty({},q,function(a){var c=$(this);return G(a,function(a){var d=b[a].tag;c.removeClass("Vo Va Mo Pl Da").addClass(d).data("type",a),c.data("manager").input()},!1),!1})).addClass("Vo").data("type",0),g.on(_defineProperty({},q,function(a){var b=$(this);return s.resetWhenRegroup.value&&T(),G(a,function(a){I(b,a);try{b.closest("table").data("manager").input()}catch(c){c instanceof Error?console.error(c):U(c)}},!0),b.addClass("selecting"),!1})).text("Vo").addClass("Vo").data("type",0),e.on(_defineProperty({},q,H)),!function(){var a=$("#progress"),c=$("#bar"),d=0,e=0,f=[];$("#VS").on(_defineProperty({},q,function(){new Promise(function(b){i.empty(),F[0].input(),F[1].input(),a.show(),B=$(".win").length,C=$(".lose").length,setTimeout(b,0)}).then(g).then(function(){return j(F[0],F[1])})["catch"](function(a){a instanceof Error?console.error(a):U(a),window.ga&&ga("send","exception",{exDescription:a.message||a,exFatal:a instanceof Error})}).then(function(){a.fadeOut(),c.fadeOut()})}));var g=function(){return new Promise(function(a,b){for(var c=0;2>c;c++){var d=F[c].fixed.length;if(d%3>0)return F[c].$known.eq(d).addClass("error"),b("確定枠はステージ(3人)単位で指定してください。")}a()})},h=0,j=function(a,b){window.performance&&(h=performance.now());var c=[];c=K(b.fixed,b.rest,b.rest.length);var d=[],e=b.fixed.length-a.fixed.length;if(e>0)for(var f,g=K(a.fixed,a.rest,e),i=0;f=g[i];i++){for(var j=a.unit.slice(0),k=0,l=f.length;l>k;k++)j.splice(j.indexOf(f[k]),1);d=d.concat(L(j,f))}else d=L(a.rest,a.fixed);return m(d,c)},k=function(){d++;var a=Math.round(100*d/e);c.width(a+"%")},l=function(a,b){return new Promise(function(c){for(var d,e={unit:a,win:0},g=0;d=b[g];g++){var h=D(F[0],a,F[1],d);1===s.countPerMatch.value?e.win+=h:h&&e.win++}f.push(e),s.showProgress.value&&k(),setTimeout(c,0)})},m=function(a,b){d=0,e=a.length,s.showProgress.value&&c.width(0).show(),f=[];for(var g=Promise.resolve(),i=0,j=a.length;j>i;i++)g=g.then(l.bind(null,a[i],b));return g.then(function(){f.sort(function(a,b){return b.win-a.win});for(var a=0,c=0,d=0,e=parseInt(s.resultDisplay.value)||10,g=[],i=Math.max(F[0].fixed.length,F[1].fixed.length);e>c&&f[a];){var j=f[a];if(a>0&&j.win===f[a-1].win&&s.omitDuplicatedResults.value){if(p(j.unit,g,i)){a++;continue}}else d=c+1;g.push(j.unit.toString()),n(d,j.unit,(j.win/b.length).toFixed(3)),a++,c++}if(window.ga){ga("send","event","fixed","you",F[0].fixed.length),ga("send","event","fixed","rival",F[1].fixed.length);for(var k in s)s.hasOwnProperty(k)&&ga("send","event","config",s[k].text,s[k].value);if(window.performance){var l=F[0].fixed.length+":"+F[1].fixed.length;ga("send","timing","Calculation",l,performance.now()-h)}}})},n=function(a,c,d){for(var e=$("<tr>").appendTo(i).append($("<td>").text(a).addClass("rank")),f=0;3>f;f++)for(var g=$("<td>").addClass("unit3-wrapper").appendTo(e),h=0;3>h;h++){var j=b[c[3*f+h]].tag;$("<div>").addClass("idol "+j).text(j).data("type",c[3*f+h]).appendTo(g)}$("<td>").text(d).appendTo(e).addClass("rate");var k=[o(1,e),o(2,e)];$("<td>").addClass("util").append(k).appendTo(e)},o=function(a,b){return $("<a>").text(a).on(_defineProperty({},q,J.bind(null,a,b))).addClass("copy button").attr("title",["1st","2nd","3rd"][a-1]+"ステージの並びを確定欄に反映")},p=function(a,b,c){if(c>=6)return!1;if(3>=c&&~b.indexOf([a[0],a[1],a[2],a[6],a[7],a[8],a[3],a[4],a[5]].toString()))return!0;if(0===c){if(~b.indexOf([a[6],a[7],a[8],a[0],a[1],a[2],a[3],a[4],a[5]].toString()))return!0;if(~b.indexOf([a[6],a[7],a[8],a[3],a[4],a[5],a[0],a[1],a[2]].toString()))return!0;if(~b.indexOf([a[3],a[4],a[5],a[0],a[1],a[2],a[6],a[7],a[8]].toString()))return!0;if(~b.indexOf([a[3],a[4],a[5],a[6],a[7],a[8],a[0],a[1],a[2]].toString()))return!0}return!1}}();var J=function(a,b){for(var c=b.find(".idol"),d=3*(a-1);3*a>d;d++){var e=c.eq(d).data("type");I(F[0].$known.eq(d),e)}var f=$(".known-unit").eq(a-1);y(f,f.find(".expectation")),F[0].input()};$("#reset-all").on(_defineProperty({},q,function(){i.empty(),T()}));for(var K=function(a,b,c){var d=[];return function e(a,b,c){if(c>0){for(var f=0,g=b.length;g>f;f++)if(!(f>0&&b[f]===b[f-1])){var h=[].concat(b),i=h.splice(f,1);e(a.concat(i),h,c-1)}}else d.push(a)}(a,b,c),d},L=function(a,b){if(!a.length)return[b];a.sort(o),b=b||[];var c=a.length;if(3===c)return[b.concat(a)];for(var d=[],e=0;c-2>e;e++)if(!(e>0&&a[e]===a[e-1]))for(var f=e+1;c-1>f;f++)if(!(f>e+1&&a[f]===a[f-1]))for(var g=f+1;c>g;g++)if(!(g>f+1&&a[g]===a[g-1])){var h=[a[e],a[f],a[g]];if(d[0]!==h){var i=a.slice(0);i.splice(g,1),i.splice(f,1),i.splice(e,1);for(var j=L(i,b.slice(3)),k=0,l=j.length;l>k;k++)d.push(b.concat(h,j[k]))}}return d},M=[{text:"単色染め",generate:function(a){var b=a.type;a.unit=[b,b,b,b,b,b,b,b,b]}},{text:"両翼楔型",generate:function(a){var b=a.type,c=(b+2)%5,d=(b+3)%5;a.unit=[b,b,b,c,c,c,d,d,d]}},{text:"楔型弱点カバー",generate:function(a){var b=a.type,c=(b+3)%5,d=(c+3)%5;a.unit=[b,b,b,c,c,c,d,d,d]}},{text:"63弱点カバー",generate:function(a){var b=a.type,c=(b+3)%5;a.unit=[b,b,b,b,b,b,c,c,c]}},{text:"ランダム",generate:function(a){a.type=Math.floor(5*Math.random());for(var b=0;9>b;b++)a.unit[b]=Math.floor(5*Math.random())}}],N=$("<ul>").appendTo("#rival-template"),O=function(a){var b=M[a];$("<a>").addClass("button").on(_defineProperty({},q,function(){T(),b.generate(F[1]),F[1].output()})).text(b.text).appendTo(N).wrap("<li>")},P=0;P<M.length;P++)O(P);var Q,R,S,T=function(){for(var a=0;2>a;a++)F[a].$known.removeClass(c+"error").empty(),F[a].fixed=[],F[a].rest=F[a].unit;$(".expectation").empty().removeClass("win lose")},U=function(a){var b=1e3*s.messageFadeTime.value;m.text(a).show().delay(b).fadeOut({complete:function(){m.text("")}}),console.info(a)};!function(){var a=$("#overlay"),b=void 0,c=function(){return 0},e=function(d,e){return a.has(d)?(b=d,c=e,a.fadeIn({easing:"easeOutExpo"}),void d.animate({top:"10%"},{easing:"easeOutBack"})):!1};Q=function(){b.animate({top:"200%"},{easing:"easeInBack"}),a.fadeOut({easing:"easeInExpo"}),c&&c()},a.on(_defineProperty({},q,Q)).children().on(_defineProperty({},q,function(a){a.stopPropagation()})),$(".close-button").text("×").on(_defineProperty({},q,Q)),$("#config-button").on(_defineProperty({},q,function(){e(f,function(){var a={};for(var b in s)s.hasOwnProperty(b)&&(a[b]=s[b].value);var c=JSON.stringify(a);window.localStorage.setItem("config",c)})})),!function(){var a,b=function(){return c.select(),!1},c=$("#input-save-name").on((a={},_defineProperty(a,q,b),_defineProperty(a,"focus",b),a)),f=$("#save-dialog");f.find(".button").on(_defineProperty({},q,function(){var a=c.val();F[0].save(a),S(),n.val(a),Q()})),$("#save-unit").addClass("save").on(_defineProperty({},q,function(){e(f,function(){return 0})}));var g=$("#simple-dialog"),h=$("#dialog-text"),i=$("#dialog-ok");g.find(".button").on(_defineProperty({},q,Q)),n.on({change:function(){c.val(n.val()),F[0].load(n.val())}});var j=function(a,b){b.remove(),delete d[a],window.localStorage.setItem("unit",JSON.stringify(d)),window.localStorage.setItem("default_unit",n.children().first().val()),0===Object.keys(d).length&&R()};R=function(){n.attr({disabled:"disabled"}),k.addClass("no-data")},S=function(){n.removeAttr("disabled"),k.removeClass("no-data")};var k=$("#delete-unit").on(_defineProperty({},q,function(){var a=n.find("option:selected"),b=a.text();h.text("本当に["+b+"]を削除してもよろしいですか？"),i.off(".delete").on(q+".delete",function(){U("["+b+"]を削除しました。"),j(b,a)}),e(g,function(){return 0})}))}(),!function(){var a=$("#memo"),b=a.find("textarea"),c=function(){b.off(".initial").empty()},d=window.localStorage.getItem("memo");if(d)b.val(d);else{var f;b.text("簡易メモです。\nこのページを閉じると保存されていない内容は失われます。\n単色構成支配人の名前を記録するのに使うといいんじゃないですかね。").on((f={},_defineProperty(f,q+".initial",c),_defineProperty(f,"focus.initial",c),f))}$("#open-memo").on(_defineProperty({},q,function(){e(a,function(){return 0})})),$("#save-memo").on(_defineProperty({},q,function(){return b.val()&&window.localStorage?(window.localStorage.setItem("memo",b.val()),void U("メモの内容をブラウザに保存しました。")):!1})),$("#delete-memo").on(_defineProperty({},q,function(){b.val("").empty()}))}()}(),Promise.resolve(0).then(function(){$("#unable-js").remove(),$("#unit-area").show(),$("#version").text("ver. "+a);var b=window.localStorage.getItem("unit");if(b){var c=JSON.parse(b);for(var e in c)d[e]=c[e],$("<option>").text(e).prop({val:e}).appendTo(n),S();var f=window.localStorage.getItem("default_unit");void 0!==f&&d[f]&&(F[0].load(f),n.val(f))}})["catch"](function(a){console.debug("初期化処理に失敗しました",a),window.localStorage.clear()}).then(function(){var a=window.localStorage.getItem("config");if(a){var b=JSON.parse(a);for(var c in b)s.hasOwnProperty(c)&&s[c].set(b[c])}})}),window.Promise||window.ga&&ga("send","exception",{exDescription:"Promise unsupported",exFatal:!0});