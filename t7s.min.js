$(document).ready(function(){"use strict";var a=[{name:"ボーカリスト",tag:"Vo"},{name:"バラドル",tag:"Va"},{name:"モデル",tag:"Mo"},{name:"プレイヤー",tag:"Pl"},{name:"ダンサー",tag:"Da"},{name:"ノータイプ",tag:"NT"}],b="Vo Va Mo Pl Da NT ",c=$("body"),d=$("#config"),e=$(".unit td"),f=$(".unit"),g=$("#result-table tbody"),h=$("#known"),i=$("#you"),j=$("#rival"),k=$("#message"),l=$("#overlay"),m=function(a,b){return a-b},n=function(a){return 0>=a?1:a*n(a-1)},o={n:0};o.YN=function(a,b){var c=this;this.value=b||!1;var d="TN"+o.n++,e=$("<input>").prop({type:"checkbox",checked:this.value,id:d}).on({change:function(){c.value=e.prop("checked")}});this.$input=$("<p>").addClass("config-input").append(e);var f=$("<label>").text(a).prop("for",d);this.$label=$("<p>").addClass("config-label").append(f)},o.YN.prototype.set=function(a){this.value=!!a,this.$input.children("input").prop({checked:a})},o.Radio=function(a,b,c){var d=this;this.value=c||0;var e="radio"+o.n++;this.text=a,this.$label=$("<p>").addClass("config-label").text(a),this.$input=$("<p>").addClass("config-input");for(var f,g=0;f=b[g];g++){var h=$("<label>").text(f).prop("for",e+"-"+g),i=$("<input>").prop({type:"radio",name:e,id:e+"-"+g,value:g,checked:g===this.value}).on({change:function(a){return function(){d.value=a}}(g)});this.$input.append(i,h,"<br>")}},o.Radio.prototype.set=function(a){this.value=parseInt(a),this.$input.children("input").prop({checked:!1}).eq(a).prop({checked:!0})},o.Quantity=function(a,b,c,d){var e=this;this.$label=$("<p>").addClass("config-label").text(a);var f=$("<input>").prop({type:"number",min:b,max:c,value:d||b}).addClass("config-number").on({change:function(){e.value=f.val()}});this.$input=$("<p>").addClass("config-input").append(f),this.value=d||b},o.Quantity.prototype.set=function(a){this.value=a,this.$input.children("input").prop({value:a})};var p={lowestBonus:new o.YN("最下位ボーナスを適用",!1),countDrawAs:new o.Radio("引き分けのカウント法",["勝利としてカウント","敗北としてカウント","勝敗をランダムに決定"],1),ignoreUserType:new o.Radio("タイプ一致ボーナス",["勝敗判定に使用する","無視する"]),resultDisplay:new o.Quantity("結果の表示数",1,1680,8),resetWhenRegroup:new o.YN("編成変更時に確定枠をリセットする",!0),showProgress:new o.YN("計算中プログレスバーを表示する",!0),messageFadeTime:new o.Quantity("メッセージの表示時間(秒)",0,1/0,1)};for(var q in p){var r=$("<div>").addClass("config-content").appendTo(d);p[q].$label.appendTo(r),p[q].$input.appendTo(r)}for(var s=$(".known-unit"),t=function(a){var c=s.clone().removeClass("template").appendTo(h),d=c.find(".unit-caption").text(["1st","2nd","3rd"][a]+" Unit"),e=$("<span>").addClass("expectation").appendTo(d).on({click:function(a){var b=$(this);b.toggleClass("win lose").text("WIN"===b.text()?"LOSE":"WIN")}});c.find("td:not(:last-child)").addClass("idol").on({click:function(a){var b=$(this);return D(a,function(a){b.removeClass("error"),F(b,a);var d=b.data("manager");try{d.input()}catch(f){O(f),d.resetFix()}0===$("td:empty",c).length?v(c,e):e.empty().removeClass("win lose")},!0),!1}}),c.find("td:last-child").append($('<a class="button">').text("Reset").on({click:function(){var a=$(this);a.parent().siblings("td").empty().removeClass(b+"error")}}))},u=0;3>u;u++)t(u);var v=function(a,b){var c=a.find(".idol").not(":empty");if(6===c.length){for(var d=[[],[]],e=0;3>e;e++)d[0].push(c.eq(e).data("type")),d[1].push(c.eq(e+3).data("type"));var f=A(c.first().data("manager").type,d[0],c.last().data("manager").type,d[1]);b.text(f?"WIN":"LOSE").removeClass("win lose").addClass(f?"win":"lose")}};s.remove();var w=function(a){return 0>a||a>=5||!isFinite(a)?NaN:(a+1)%5},x=function(a,b,c,d){return w(b)===d?3:b===w(d)?-3:0===p.ignoreUserType.value&&a===b&&c!==d?1:0===p.ignoreUserType.value&&a!==b&&c===d?-1:p.lowestBonus.value?1:0},y=0,z=0,A=function(a,b,c,d){for(var e=z,f=y;3>f;f++){for(var g=0,h=0;3>h;h++)g+=x(a,b[3*f+h],c,d[3*f+h]);if(g>0?e++:0>g&&e--,e>=2)return!0;if(-2>=e)return!1}if(0!==e)return e>0;switch(p.countDrawAs.value){case 0:return!0;case 1:return!1;case 2:return Math.random()>.5}},B=function(a,b){this.type=0,this.unit=[0,0,0,0,0,0,0,0,0],this.fixed=[],this.rest=this.unit,this.$=a,this.$table=a.children(".unit").data("manager",this),this.$cell=a.find(".unit td"),this.$pattern=a.find(".pattern"),this.$known=b.children("td:not(:last-child)").data("manager",this)};B.prototype={getPattern:function(){for(var a=[0,0,0,0,0],b=0;9>b;b++)a[this.unit[b]]++;for(var c=362880,d=0;5>d;d++)c/=n(a[d]);return c},resetFix:function(){this.fixed=[],this.rest=[].concat(this.unit)},sort:function(){this.unit.sort(m),this.rest.sort(m)},input:function(){var a=this;this.type=this.$table.data("type"),this.$cell.each(function(b,c){var d=$(c).data("type");a.unit[b]=d}),this.resetFix();for(var b=0;9>b;b++){var c=this.$known.eq(b);if(""===c.text())break;var d=c.removeClass("error").data("type");this.fixed.push(d);var e=this.rest.indexOf(d);if(0>e)throw c.addClass("error"),"確定欄のユニットが編成不可能な組合せです";this.rest.splice(e,1)}this.sort()},output:function(){var b=a[this.type].tag;this.$table.data("type",this.type).removeClass("Vo Va Mo Pl Da").addClass(b);for(var c=0;9>c;c++)F(this.$cell.eq(c),this.unit[c])},save:function(a){var b=JSON.stringify({type:this.type,unit:this.unit});window.localStorage.setItem("unit"+a,b),O("スロット"+(a+1)+"にユニットデータを保存しました")},load:function(a){var b=window.localStorage.getItem("unit"+a);if(!b)throw"スロット"+(a+1)+"にはユニットデータがありません";var c=JSON.parse(b);this.type=c.type,this.unit=c.unit||[0,0,0,0,0,0,0,0,0],this.output()}};var C=[new B(i,$(".you.used-unit")),new B(j,$(".rival.used-unit"))],D=function(b,d,f){var g=f?6:5;$(".type-select").remove(),e.removeClass("selecting");for(var h=$("<ul>").addClass("type-select").appendTo(c).css({top:b.pageY,left:b.pageX}),i=0;g>i;i++){var j=$("<a>").text(a[i].tag).addClass(a[i].tag).attr({title:a[i].name});j.on({click:function(a){return function(b){return d(a),E(b),!1}}(i)}).appendTo(h).wrap('<li class="type-option">')}b.stopPropagation()},E=function(a){var b=$(".type-select").eq(0);b.addClass("dispose").delay(150).queue(function(a){b.hide().remove()}),e.removeClass("selecting"),a.stopPropagation()},F=function(b,c){var d=a[c].tag;b.removeClass("Vo Va Mo Pl Da NT selecting").addClass(d).text(d).data("type",c)};f.on({click:function(b){var c=$(this);return D(b,function(b){var d=a[b].tag;c.removeClass("Vo Va Mo Pl Da").addClass(d).data("type",b),c.data("manager").input()},!1),!1}}).addClass("Vo").data("type",0),e.on({click:function(a){var b=$(this);return p.resetWhenRegroup.value&&N(),D(a,function(a){F(b,a);try{b.closest("table").data("manager").input()}catch(c){c instanceof Error?console.error(c):O(c)}},!0),b.addClass("selecting"),!1}}).text("Vo").addClass("Vo").data("type",0),c.on({click:E}),!function(){var b=$("#progress"),c=$("#bar"),d=0,e=0,f=[];$("#VS").on({click:function(){new Promise(function(a){g.empty(),C[0].input(),C[1].input(),b.show(),z=$(".win").length,y=$(".lose").length+z,setTimeout(a,0)}).then(h).then(function(){return j(C[0],C[1])})["catch"](function(a){a instanceof Error?console.error(a):O(a)}).then(function(){b.fadeOut(),c.fadeOut()})}});var h=function(){return new Promise(function(a,b){for(var c=[C[0].fixed.length,C[1].fixed.length],d=0;2>d;d++)if(c[d]%3>0)return C[d].$known.eq(c[d]).addClass("error"),b("確定枠はユニット(3人)単位で指定してください。");a()})},i=0,j=function(a,b){window.performance&&(i=performance.now());var c=[];c=H(b.fixed,b.rest,b.rest.length);var d=[],e=b.fixed.length-a.fixed.length;if(e>0)for(var f,g=H(a.fixed,a.rest,e),h=0;f=g[h];h++){for(var j=a.unit.slice(0),k=0,l=f.length;l>k;k++)j.splice(j.indexOf(f[k]),1);d=d.concat(I(j,f))}else d=I(a.rest,a.fixed);return m(d,c)},k=function(){d++;var a=Math.round(100*d/e);c.width(a+"%")},l=function(a,b){return new Promise(function(c){for(var d,e={unit:a,win:0},g=0;d=b[g];g++)A(C[0],a,C[1],d)&&e.win++;f.push(e),p.showProgress.value&&k(),setTimeout(c,0)})},m=function(a,b){d=0,e=a.length,p.showProgress.value&&c.width(0).show(),f=[];for(var g=Promise.resolve(),h=0,j=a.length;j>h;h++)g=g.then(l.bind(null,a[h],b));return g.then(function(){f.sort(function(a,b){return b.win-a.win});for(var a=0,c=0,d=0,e=parseInt(p.resultDisplay.value)||10,g=[],h=Math.max(C[0].fixed.length,C[1].fixed.length);e>c&&f[a];){var j=f[a];if(a>0&&j.win===f[a-1].win){if(q(j.unit,g,h)){a++;continue}}else d=c+1;g.push(j.unit.toString()),n(d,j.unit,(j.win/b.length).toFixed(3)),a++,c++}window.performance&&ga&&ga("send","timing","JS Dependencies","calc",performance.now()-i)})},n=function(b,c,d){for(var e=$("<tr>").appendTo(g).append($("<td>").text(b).addClass("rank")),f=0;3>f;f++)for(var h=$("<td>").addClass("unit3-wrapper").appendTo(e),i=0;3>i;i++){var j=a[c[3*f+i]].tag;$("<div>").addClass("idol "+j).text(j).data("type",c[3*f+i]).appendTo(h)}$("<td>").text(d).appendTo(e).addClass("rate");var k=[o(1,e),o(2,e)];$("<td>").append(k).appendTo(e)},o=function(a,b){return $("<a>").text(a).on({click:G.bind(null,a,b)}).addClass("copy button").attr("title",["1st","2nd","3rd"][a-1]+"ユニットの並びを確定欄に反映")},q=function(a,b,c){if(c>=6)return!1;if(3>=c&&~b.indexOf([a[0],a[1],a[2],a[6],a[7],a[8],a[3],a[4],a[5]].toString()))return!0;if(0===c){if(~b.indexOf([a[6],a[7],a[8],a[0],a[1],a[2],a[3],a[4],a[5]].toString()))return!0;if(~b.indexOf([a[6],a[7],a[8],a[3],a[4],a[5],a[0],a[1],a[2]].toString()))return!0;if(~b.indexOf([a[3],a[4],a[5],a[0],a[1],a[2],a[6],a[7],a[8]].toString()))return!0;if(~b.indexOf([a[3],a[4],a[5],a[6],a[7],a[8],a[0],a[1],a[2]].toString()))return!0}return!1}}();var G=function(a,b){for(var c=b.find(".idol"),d=3*(a-1);3*a>d;d++){var e=c.eq(d).data("type");F(C[0].$known.eq(d),e)}var f=$(".known-unit").eq(a-1);v(f,f.find(".expectation")),C[0].input()};$("#reset-all").on({click:function(){g.empty(),N()}});var H=function(a,b,c){var d=[];return function e(a,b,c){if(c>0){for(var f=0,g=b.length;g>f;f++)if(!(f>0&&b[f]===b[f-1])){var h=[].concat(b),i=h.splice(f,1);e(a.concat(i),h,c-1)}}else d.push(a)}(a,b,c),d},I=function(a,b){if(!a.length)return[b];a.sort(m),b=b||[];var c=a.length;if(3===c)return[b.concat(a)];for(var d=[],e=0;c-2>e;e++)if(!(e>0&&a[e]===a[e-1]))for(var f=e+1;c-1>f;f++)if(!(f>e+1&&a[f]===a[f-1]))for(var g=f+1;c>g;g++)if(!(g>f+1&&a[g]===a[g-1])){var h=[a[e],a[f],a[g]];if(d[0]!==h){var i=a.slice(0);i.splice(g,1),i.splice(f,1),i.splice(e,1);for(var j=I(i,b.slice(3)),k=0,l=j.length;l>k;k++)d.push(b.concat(h,j[k]))}}return d};!function(){for(var b=$("<ul>").appendTo("#save-slot"),c=5,d=function(a){var c=window.localStorage.getItem("unit"+a),d=$("<li>").appendTo(b),e=$("<a>").addClass("save button").on({click:function(a){return function(){e.removeClass("no-data"),g.data("unit",{type:C[0].type,unit:C[0].unit}).removeClass("no-data"),C[0].save(a)}}(a)}).text("SAVE "+(a+1)).appendTo(d),g=$("<a>").addClass("load button").on({click:C[0].load.bind(C[0],a),mouseover:function(){f(g,g.data("unit"))},mouseout:function(){$("#mini-unit").remove()}}).text("LOAD "+(a+1)).appendTo(d);if(c){var h=JSON.parse(c);g.data("unit",h)}else g.addClass("no-data")},e=0;c>e;e++)d(e);var f=function(b,c){var d=$('<table id="mini-unit">').addClass(a[c.type].tag).appendTo(b);$("<caption>").appendTo(d).text(a[c.type].name);for(var e=0;3>e;e++)for(var f=$("<tr>").appendTo(d),g=0;3>g;g++){var h=a[c.unit[3*e+g]].tag;$("<td>").appendTo(f).addClass(h).text(h)}}}();for(var J=[{text:"単色染め",generate:function(a){var b=a.type;a.unit=[b,b,b,b,b,b,b,b,b]}},{text:"両翼楔型",generate:function(a){var b=a.type,c=(b+2)%5,d=(b+3)%5;a.unit=[b,b,b,c,c,c,d,d,d]}},{text:"楔型弱点カバー",generate:function(a){var b=a.type,c=(b+3)%5,d=(c+3)%5;a.unit=[b,b,b,c,c,c,d,d,d]}},{text:"63弱点カバー",generate:function(a){var b=a.type,c=(b+3)%5;a.unit=[b,b,b,b,b,b,c,c,c]}},{text:"ランダム",generate:function(a){a.type=Math.floor(5*Math.random());for(var b=0;9>b;b++)a.unit[b]=Math.floor(5*Math.random())}}],K=$("<ul>").appendTo("#rival-template"),L=function(a){var b=J[a];$("<a>").addClass("button").on({click:function(){N(),b.generate(C[1]),C[1].output()}}).text(b.text).appendTo(K).wrap("<li>")},M=0;M<J.length;M++)L(M);var N=function(){for(var a=0;2>a;a++)C[a].$known.removeClass(b+"error").empty(),C[a].fixed=[],C[a].rest=C[a].unit;$(".expectation").empty().removeClass("win lose")},O=function(a){var b=1e3*p.messageFadeTime.value;k.text(a).show().delay(b).fadeOut({complete:function(){k.text("")}}),console.info(a)},P=function(){d.animate({top:"200%"},{easing:"easeInBack"}),l.fadeOut({easing:"easeInExpo"});var a={};for(var b in p)p.hasOwnProperty(b)&&(a[b]=p[b].value);var c=JSON.stringify(a);window.localStorage.setItem("config",c)};l.on({click:P}).children().on({click:function(a){a.stopPropagation()}}).children().first().on({click:P}),$("#config-button").on({click:function(){l.fadeIn({easing:"easeOutExpo"}),d.animate({top:"10%"},{easing:"easeOutBack"})}}),Promise.resolve(0).then(function(){$("#unable-js").remove(),$("#unit-area").show(),C[0].load(0)})["catch"](function(a){console.debug("初期化処理に失敗しました",a)}).then(function(){var a=window.localStorage.getItem("config");if(a){var b=JSON.parse(a);for(var c in b)p.hasOwnProperty(c)&&p[c].set(b[c])}})});